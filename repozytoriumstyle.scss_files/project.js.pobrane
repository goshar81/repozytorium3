$.fn.extend({animateCss:function(a){var b="webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend";$(this).addClass("animated "+a).one(b,function(){$(this).removeClass("animated "+a)})}}),App.Views.ProjectNavbar=Backbone.View.extend({initialize:function(a){this.editor=a.editor,this.$menu=this.$(".project-buttons")},events:{"click a[data-action]":"execAction","hover .project-buttons .dropdown-toggle":"menuHover"},execAction:function(a){this.editor[$(a.currentTarget).data("action")].apply(this.editor,arguments),a.preventDefault()},menuHover:function(a){var b=this.$menu.children(".dropdown.open");b.length&&(b.removeClass("open"),$(a.currentTarget).parent().addClass("open"))}}),App.Views.FileSaveModal=Backbone.View.extend({events:{"click .btn-save":"save","click .btn[data-dismiss]":"cancel","click .btn-create-folder":"createFolder",'keydown input[name="filename"]':"fileKeyDown"},initialize:function(){this.$filename=this.$('input[name="filename"]')},setEditor:function(a){return this.editor=a,this},enableDisableSaveButton:function(){var a=""===this.$filename.val();return this.$(".btn-save").prop("disabled",a),!a},fileKeyDown:function(a){var b=this;setTimeout(function(){b.enableDisableSaveButton()&&13==(a.which||a.keyCode)&&b.save()},0)},save:function(){var a=this,b=this.selectedNode(function(){return a.treeView.getNode(0)});this.defer.resolve(null,b.path,this.$('input[name="filename"]').val(),b)},clearFilename:function(){this.$filename.val("")},cancel:function(){this.defer.resolve(!0)},createFolder:function(){var a=this,b=this.selectedNode(function(){return a.treeView.getNode(0)}),c=this.treeView.addNode(b,{nodes:[],editable:!0,text:App.Translations("newFolder"),onSaved:function(){var c=this.text,d=[b.path,c];b.path||d.shift();var e={text:c,path:d.join("/"),nodes:[]};return a.trigger("folderCreated",b,e),e}});this.treeView.selectNode(c),this.treeView.revealNode(c)},selectedNode:function(a){var b=this.treeView.getSelected().pop();return!b&&a?a():b},prepareTreeView:function(){var a=this,b=this.$(".tree-view");try{b.treeview("destroy")}catch(c){}this.treeView=b.treeview({color:"#428bca",showBorder:!1,data:this.data,expandIcon:"fa fa-folder",collapseIcon:"fa fa-folder-o",onNodeSelected:function(b,c){a.treeView.expandNode(c.nodeId)},onNodeBuilded:function(b,c){new App.Views.TreeViewFolder({node:b,editor:a.editor,treeView:this,el:c,onDelete:function(){a.trigger("folderDeleted",b)}})},filter:function(a){return!a.file}}).data("treeview")},show:function(a){return this.data=a,this.defer=$.Deferred(),this.prepareTreeView(),this.$el.modal("show"),this.enableDisableSaveButton(),this.defer},hide:function(){this.$el.modal("hide")}}),App.Views.ProjectEditModal=Backbone.View.extend({events:{"show.bs.modal":"render","click .btn-save":"saveProject","submit form":"saveProject"},initialize:function(a){this.$name=this.$('textarea[name="name"]'),this.$description=this.$('textarea[name="description"]'),this.project=a.project,this.listenTo(this.project,"change:name change:description",this.render)},render:function(){this.$name.val(this.project.get("name")),this.$description.val(this.project.get("description"))},saveProject:function(a){a&&a.preventDefault(),this.project.set({name:this.$name.val(),description:this.$description.val()});var b=this;this.project.save().done(function(){b.$el.modal("hide")})}}),App.Views.ProjectEditor=App.Views.Editor.extend({initialize:function(a){this.isOwner=!!parseInt(this.$el.data("isOwner"),10),this.projectId=parseInt(this.$el.data("projectId"),10),this.navbar=new App.Views.ProjectNavbar({el:a.$navbar,editor:this}),this.fileSaveModal=a.fileSaveModal.setEditor(this),this.bootcampProjectReviewSubmitModal=a.bootcampProjectReviewSubmitModal,this.bootcampProjectReviewCard=a.bootcampProjectReviewCard,this.listenTo(this.fileSaveModal,"folderCreated",this.folderCreated),this.listenTo(this.fileSaveModal,"folderDeleted",this.folderDeleted),this.model=this.project=new App.Models.Project({id:this.projectId}),this.editModal=new App.Views.ProjectEditModal({el:a.$editModal,project:this.project}),this.treeViewNodes=new HashMap,this.$autosave=a.$navbar.find('[data-action="toggleAutosave"]').addClass("autosave-on"),this._super(a)},events:function(){return $.extend({"click .reload-preview":"reloadPreview","click .aside-toggle":"toggleAside",'click [data-action="show-manual-modal"]':"showManualModal"},this._super())},toggleAside:function(){this.$el.toggleClass("aside-minimized"),$("#bootcamp-project-review-card").toggleClass("minimal"),this.$preview.is(":visible")&&this.$el.children("#preview").length<1&&this.activateSplitter()},folderCreated:function(a,b){var c=this.treeViewNodes.get(a.dataObject);this.treeView.addNode(c,b,!1)},deleteFolder:function(a){return $.ajax({url:"/"+App.getLang()+"/project-folder",type:"DELETE",data:{project_id:this.project.id,path:a}})},folderDeleted:function(a){this.treeView.removeNode(this.treeViewNodes.get(a.dataObject))},setActiveFile:function(a,b){this._super(a,b);var c=a.get("treeNode");c&&this.treeView.selectNode(c),this.showHidePlug()},fileOpenedOrClosed:function(a){if(a.get("opened")||a.set("unsaved",!1),a.get("active")&&!a.get("opened")){var b=this.files().findWhere({opened:!0});b&&this.setActiveFile(b)}this.showHidePlug()},showHidePlug:function(){var a=this.files().where({opened:!0});a.length<1?this.$plug.show():this.$plug.hide()},share:function(){$("#share-modal").modal("show")},showManualModal:function(){$("#manual-modal").modal("show")},sendToMentor:function(){var a=this;this.files().getUnsavedFiles().length&&App.alertsView.showWarnings({message:App.Translations("projectNotSavedBeforeSentToReview")}),this.bootcampProjectReviewSubmitModal.show().done(function(b,c,d){var e=new App.Models.BootcampProjectReview({project_id:a.project.get("id"),submodules:b,comment:c});e.save().done(function(){App.alertsView.showSuccess({message:App.Translations("projectSentToReview")});var b=a.navbar.$(".project-status");b.html(d),b.removeClass(),b.addClass("project-status project-in-review"),a.bootcampProjectReviewSubmitModal.reset(),a.bootcampProjectReviewSubmitModal.hide()})})},review:function(a,b,c){return this.project.get("bootcamp_project_review").set({accepted:a,annotations:b}).save()},edit:function(){$("#edit-modal").modal("show")},addSavedFileToMainTreeView:function(a,b){this.treeView.removeNode(this.activeFile.get("treeNode"));var c=this.treeViewNodes.get(a.dataObject),d=this.treeView.addNode(c,{text:b,icon:"fa fa-file",file:this.activeFile});this.treeView.revealNode(d)},saveFile:function(){if(App.alertsView.hideAll(),this.activeFile.isNew()){var a=this;return this.fileSaveModal.show(this.treeViewData).done(function(b,c,d,e){b||a.activeFile.set({path:c,filename:d}).save().done(function(){a.addSavedFileToMainTreeView(e,d),a.setHighlightMode(),a.hide(),a.fileSaveModal.clearFilename()}).error(function(b){a.activeFile.set({path:"",filename:"untitled"}),App.alertsView.showErrors(b.responseJSON),a.hide()})})}return this.activeFile.save()},saveAllFiles:function(){var a=this.files().getUnsavedFiles();return a.length<1?$.Deferred():$.when.apply(null,a.map(function(a){return a.save()}))},hide:function(){this.fileSaveModal.hide()},isAutosaveEnabled:function(){return this.$autosave.hasClass("autosave-on")},resetAutosave:function(){if(clearInterval(this.autosaveInterval),this.isAutosaveEnabled()){var a=this;this.autosaveInterval=setInterval(function(){a.saveAllFiles().done($.proxy(a.updatePreview,a))},3e5)}},toggleAutosave:function(a){$(a.currentTarget).toggleClass("autosave-on"),this.resetAutosave(),a.stopPropagation()},newFile:function(){var a=this.files().add({filename:"untitled",path:"",project_id:this.projectId,mime:"",content:""});this.setActiveFile(a);var b=this.treeView.getNode(0),c=this.treeView.addNode(b,{text:"untitled",icon:"fa fa-file",file:a});this.treeView.revealNode(c)},deleteFile:function(a){a=a||this.activeFile,window.confirm(App.Translations("projectDeleteFileMessage")+" "+a.get("filename")+"?")&&(a.close(),a.destroy())},buildTreeViewData:function(){var a=[{text:"/",path:"",nodes:[]}],b={};return this.files().each(function(c){var d=a[0],e=[],f=c.get("path"),g=""===f?[]:f.split("/");g.forEach(function(a){e.push(a);var c=e.join("/");b[c]||(b[c]={text:a,path:c,nodes:[]},d.nodes.push(b[c])),d=b[c]}),d.nodes.push({text:c.get("filename"),icon:"fa fa-file",file:c})}),a},prepareTreeView:function(){var a=this;this.treeViewData=this.buildTreeViewData(),this.treeView=this.$(".tree-view").treeview({color:"#428bca",showBorder:!1,data:this.treeViewData,expandIcon:"fa fa-folder",collapseIcon:"fa fa-folder-o",preventUnselect:!0,onNodeSelected:function(b,c){c.file?a.setActiveFile(c.file):a.treeView.expandNode(c.nodeId)},onNodeInitialized:function(b){a.treeViewNodes.set(b.dataObject,b)},onNodeBuilded:function(b,c){b.file?(b.file.set("treeNode",b),b.file.set("treeViewFile",new App.Views.TreeViewFile({editor:a,node:b,el:c}))):new App.Views.TreeViewFolder({editor:a,node:b,treeView:this,el:c})}}).data("treeview")},render:function(){this._super(),this.$plug=this.$(".ide > div.plug");var a=this.files();this.listenTo(a,"remove",this.fileRemoved),this.listenTo(a,"change:opened",this.fileOpenedOrClosed),this.listenTo(a,"change:css",this.cssCompiled);var b=a.findWhere({filename:"index.html"});b&&this.setActiveFile(b)},cssCompiled:function(a,b){a.set({css:null},{silent:!0});var c=[a.name(),"css"].join("."),d=this.files().findWhere({filename:c,path:a.get("path")});return d?(setTimeout(function(){d.get("treeViewFile").shake()},0),void d.setContent(b)):App.alertsView.showWarnings({message:App.Templates("createTargetCssFile")({filename:c})})},fileRemoved:function(a){this.treeView.removeNode(a.get("treeNode"))},prepareView:function(){this._super(),this.isOwner||this.editor.setReadOnly(!0),this.prepareKeyboardShortcuts(),this.prepareTreeView()},prepareKeyboardShortcuts:function(){var a={"ctrl+alt+n":this.newFile,"ctrl+s":this.saveFile,"ctrl+r":this.reloadPreview,"ctrl+shift+s":this.saveAllFiles,"meta+s":this.saveFile,"meta+shift+s":this.saveAllFiles},b=this;$.each(a,function(a,c){b.editor.commands.bindKey(a,function(){c.call(b)}),key(a,function(a){a.preventDefault(),c.call(b)})})},onEditorContentChanged:function(a){this.editor.silent||(this.resetAutosave(),this.changeFileContent(),this.activeFile.set("unsaved",!0))},reloadPreview:function(){return this.files().hasUnsavedFiles()&&window.confirm(App.Translations("projectReloadPreviewMessage"))?this.saveAllFiles().done($.proxy(this.updatePreview,this)):void this.updatePreview()},updatePreview:function(a){return a===!0?this.$iframe.get(0).contentWindow.location.reload(!0):void this.activePreviewFile.loadToIframe(this.$iframe)}}),App.Views.TreeViewFile=Backbone.View.extend({events:{"click .btn-del":"deleteFile"},initialize:function(a){this.editor=a.editor,this.node=a.node,this.render()},render:function(){this.editor.isOwner&&"index.html"!=this.node.file.attributes.filename&&this.$el.append($('<i class="fa fa-trash btn-del" title="Usuń plik"></i>'))},deleteFile:function(a){this.editor.deleteFile(this.node.file),a.stopPropagation()},shake:function(){this.$el.animateCss("shake")}}),App.Views.TreeViewFolder=Backbone.View.extend({events:{"click .btn-del":"deleteFolder"},initialize:function(a){this.editor=a.editor,this.treeView=a.treeView,this.onDelete=a.onDelete,this.node=a.node,this.render()},render:function(){this.editor.isOwner&&this.$el.append($('<i class="fa fa-trash btn-del" title="Usuń folder"></i>'))},deleteFolder:function(a){if(a.stopPropagation(),window.confirm(App.Translations("projectTreeViewFolderDeleteFolderMessage"))){var b=this;this.editor.deleteFolder.call(this.editor,this.node.path).done(function(){b.treeView.removeNode(b.node),b.onDelete&&b.onDelete()})}}}),App.Views.BootcampProjectReviewSubmitModal=Backbone.View.extend({events:{"click .btn-save":"submit"},initialize:function(){this.$comment=this.$('textarea[name="comment"]'),this.$checkboxes=this.$('input[type="checkbox"]')},submit:function(a){a.stopPropagation();var b=$(a.currentTarget).data("status-name"),c=this.$checkboxes;c.length>1&&(c=c.filter(":checked")),this.defer.resolve(c.map(function(){return $(this).val()}).toArray(),this.$comment.val(),b)},show:function(){return this.defer=$.Deferred(),this.$el.modal("show"),this.defer},hide:function(){this.$el.modal("hide")},reset:function(){this.$checkboxes.prop("checked",!1),this.$comment.val("")}}),App.Views.BootcampProjectReviewCard=Backbone.View.extend({events:{"click .btn-save":"submit","click .btn-discard":"discard","click header":"showOrHide"},initialize:function(){this.$annotations=this.$('textarea[name="annotations"]')},showOrHide:function(){this.$el.toggleClass("open")},hide:function(){this.$el.removeClass("open")},submit:function(a){a.stopPropagation();var b=$(a.currentTarget).data("status-name");this.review(!0,this.$annotations.val(),b)},discard:function(a){a.stopPropagation();var b=$(a.currentTarget).data("status-name");this.review(!1,this.$annotations.val(),b)},review:function(a,b,c){var d=this;App.Editor.review(a,b,c).done(function(){var b=d.$(".project-status");b.removeClass(),b.html(c),a?b.addClass("project-status project-accepted"):b.addClass("project-status project-unaccepted"),d.reset(),d.hide()})},reset:function(){this.$annotations.val("")}});