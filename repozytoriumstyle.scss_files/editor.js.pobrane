App.Views.FilesList=Backbone.View.extend({initialize:function(a){this.files=a.files,this.listenTo(this.files,"add remove change:filename",this.render),this.render()},render:function(){this.tabs=[];var a=this;this.filteredFiles=this.filter?new Backbone.Collection(this.files.filter(this.filter)):this.files,this.$el.empty().append(this.filteredFiles.map(function(b,c){var d=new(Function.prototype.bind.call(a.view))({file:b,parent:a});return a.tabs.push(d),d.$el}))}}),App.Views.File=Backbone.View.extend({initialize:function(a){this.file=a.file,this.listenTo(this.file,"change",this.render),this.parent=a.parent,this.render()},render:function(){this.$el.html(App.Templates("editorTab")({filename:this.file.get("filename")})),this.prepare&&this.prepare()}}),App.Views.EditorTab=App.Views.File.extend({initialize:function(a){this._super(a),this.listenTo(this.file,"change:unsaved",this.setClasses),this.listenTo(this.file,"sync",this.setSynced)},events:{click:"setActive","click .close-tab":"close"},tagName:"a",prepare:function(){this.file.get("active")?this.$el.addClass("active"):this.$el.removeClass("active")},close:function(a){return a.stopPropagation(),(this.file.isUnsaved||this.file.isNew).call(this.file)?void(window.confirm(App.Translations("editorTabCloseMessage"))&&(this.file.close(),this.file.isNew()&&this.file.destroy())):(this.file.close(),void this.file.resetContent())},setActive:function(){App.Editor.switchCodeTab(this.file)},width:function(){return this.$el.outerWidth()},slideLeft:function(){var a=this.margin();return a<-1&&this.margin(Math.min(a+10,-1))},slideRight:function(){var a=this.width(),b=this.margin();if(b>-a){var c=this.parent.tabs;return minus=Math.min(c[c.length-1].position()-this.parent.width(),10),this.margin(Math.max(b-minus,-a))}return!1},position:function(){return this.$el.position().left+this.$el.outerWidth()},margin:function(a){return a?this.$el.css("margin-right",a+"px"):parseInt(this.$el.css("margin-right"),10)},render:function(){this._super(),this.file.get("opened")?this.show():this.hide(),this.setClasses()},setClasses:function(){this.$el.removeClass("unsaved"),this.file.get("unsaved")&&this.$el.addClass("unsaved")},setSynced:function(){this.file.set("unsaved",!1)},show:function(){this.$el.css("display","inline-block")},hide:function(){this.$el.css("display","none")}}),App.Views.EditorTabs=App.Views.FilesList.extend({view:App.Views.EditorTab,initialize:function(a){this.hideTab=0,this._super(a)},canSlideLeft:function(){return!!this.tabs[0].margin()+1},slideLeft:function(){return!!this.canSlideLeft()&&void(this.tabs[this.hideTab].slideLeft()||this.hideTab>0&&(this.hideTab-=1,this.slideLeft()))},canSlideRight:function(){return this.tabs[this.tabs.length-1].position()>this.width()},slideRight:function(){return!!this.canSlideRight()&&void(this.tabs[this.hideTab].slideRight()||this.hideTab+1<this.tabs.length&&(this.hideTab+=1,this.slideRight()))},width:function(){return this.$el.outerWidth()-6}}),App.Views.EditorTabsArrows=Backbone.View.extend({initialize:function(a){this.tabs=a.tabs,$("body").on("mouseup",$.proxy(this.stopSliding,this))},events:{"mousedown .slide-left":"slideLeft","mousedown .slide-right":"slideRight"},slideLeft:function(){this.slideLeftInterval=setInterval($.proxy(this.tabs.slideLeft,this.tabs),25)},slideRight:function(){this.slideRightInterval=setInterval($.proxy(this.tabs.slideRight,this.tabs),25)},stopSliding:function(){clearInterval(this.slideLeftInterval),clearInterval(this.slideRightInterval)}}),App.Views.EditorTabsContainer=Backbone.View.extend({initialize:function(a){this.tabs=new App.Views.EditorTabs({el:this.$(".tabs"),files:a.files}),this.arrows=new App.Views.EditorTabsArrows({el:this.$(".arrows"),parent:this,tabs:this.tabs})},width:function(){return this.$el.width()}}),App.Views.PreviewSelectOption=App.Views.File.extend({tagName:"option",prepare:function(){this.$el.attr("value",this.file.get("filename"))}}),App.Views.PreviewSelect=App.Views.FilesList.extend({view:App.Views.PreviewSelectOption,filter:function(a){return"html"==a.type()},render:function(){this._super(),this.filteredFiles.size()<2?this.$el.parent().addClass("display-none"):this.$el.parent().removeClass("display-none")}}),App.Views.Editor=Backbone.View.extend({events:function(){return{'click [data-action="layout-change"]':"layoutChange",'click [data-action="expand-preview"]':"previewExpand",'click [data-action="hide-preview"]':"hidePreview",'click [data-action="show-preview"]':"showPreview",'click [data-action="compress-preview"]':"previewCompress",'click [data-action="full-preview"]':"previewFull",'click [data-action="compact-preview"]':"previewCompact",'change [data-action="change-preview-file"]':"changePreviewFile"}},fetch:function(){this.model.fetch().done($.proxy(this.render,this))},initialize:function(){var a={Chrome:30,Firefox:30,Opera:10,Safari:7,MSIE:11},b=_.browser();return parseInt(b.version,10)<a[b.name]?(this.$el.html(App.Templates("editor")({})),this.$el.addClass("browser-unsupported")):void this.fetch()},cheatSheetToggle:function(){this.$(".cheat-sheet-container").toggleClass("open")},render:function(){this.$el.html(App.Templates("editor")(this.model.toJSON())),this.prepareView()},files:function(){return this.model.files()},initCustomScrollbar:function(a){return a.perfectScrollbar()},prepareView:function(){var a=this.files();this.tabsContainer=new App.Views.EditorTabsContainer({el:this.$(".ide .tabs-container"),files:a}),this.htmls=new App.Views.PreviewSelect({el:$("#preview-select"),files:a}),this.$(".splitter").splitter({splitVertical:!0,minLeft:360,minRight:360,splitbarClass:"vsplitbar splitter-handle"}),this.$ide=this.$(".ide"),this.$preview=this.$("#preview"),this.$previewSelect=this.$("#preview-select"),this.$iframe=this.$("#window iframe"),this.$splitter=this.$(".splitter"),this.$vsplitbar=this.$(".vsplitbar"),this.$hsplitbar=this.$(".hsplitbar"),(this.prepareAdditionalViews||$.noop).call(this),this.$("#editor").length&&(this.editor=ace.edit("editor"),this.editor.setTheme("ace/theme/monokai"),this.editor.getSession().setMode("ace/mode/html"),this.editor.getSession().setUseWrapMode(!0),this.editor.resize(),this.editor.getSession().setTabSize(4),this.editor.getSession().setUseSoftTabs(!1),this.editor.setBehavioursEnabled(!1),this.editor.setShowPrintMargin(!1),this.editor.getSession().setUseWorker(!1),$(window).width()>1366&&this.editor.setFontSize(14),this.editor.getSession().on("change",$.proxy(this.onEditorContentChanged,this)),this.$ide.on("resize",$.proxy(this.editor.resize,this.editor)),this.initCustomScrollbar(this.$(".ace_scrollbar, .csb-container, .cheat-sheet-container")),this.resizeFix())},resizeFix:function(){var a=this;$(window).on("resize",function(b){b.target===window&&($(window).off("resize"),setTimeout(function(){a.activateSplitter(),a.resizeFix()},2e3))})},removeSplittBar:function(){this.$(".vsplitbar, .hsplitbar").remove()},splitterOptions:{vertical:{splitVertical:!0,minLeft:360,minRight:360,splitbarClass:"vsplitbar splitter-handle"},horizontal:{splitHorizontal:!0,minTop:200,minBottom:200,splitbarClass:"hsplitbar splitter-handle"}},initSplitter:function(a){this.$(".splitter."+a).splitter(this.splitterOptions[a])},activateSplitter:function(){this.removeSplittBar(),this.$splitter.hasClass("vertical")?this.initSplitter("vertical"):this.$splitter.hasClass("horizontal")&&this.initSplitter("horizontal")},layoutChange:function(){this.$splitter.hasClass("vertical")?analytics.track(this.editorType+"_editor_preview_horizontal"):analytics.track(this.editorType+"_editor_preview_vertical"),this.$splitter.toggleClass("horizontal vertical"),this.activateSplitter(),this.editor.resize()},hidePreview:function(){this.removeSplittBar(),this.$preview.hide(),this.$ide.css({width:"100%",height:"100%"}),this.$('[data-action="show-preview"]').removeClass("display-none"),this.editor.resize()},showPreview:function(){this.activateSplitter(),this.$preview.show(),this.$preview.hasClass("expanded")&&this.previewExpand(),this.$('[data-action="show-preview"]').addClass("display-none"),this.editor.resize()},previewExpand:function(){this.removeSplittBar(),this.$("#ide-toggle").addClass("disabled"),this.$preview.addClass("expanded");var a=this;this.$(".expanded").draggable({drag:function(b,c){var d=a.$el.width()-a.$preview.width(),e=a.$el.height()-a.$preview.height();c.position.top=Math.max(0,c.position.top),c.position.left=Math.min(d,c.position.left),c.position.left=Math.max(0,c.position.left),c.position.top=Math.min(e,c.position.top)}}),this.$(".expanded").resizable({minHeight:200,minWidth:400}),this.$('[data-action="compress-preview"], [data-action="full-preview"]').removeClass("display-none"),this.$('[data-action="expand-preview"], [data-action="layout-change"]').addClass("display-none"),this.$splitter.hasClass("vertical")?this.$ide.width("100%"):this.$ide.height("100%"),this.$preview.css({height:"450px",width:"900px","z-index":"101",top:"calc(50vh - 290px)",left:"calc(50vw - 450px)"}).appendTo(this.$el),this.updatePreview(),analytics.track(this.editorType+"_editor_preview_modal")},previewCompress:function(){this.$("#ide-toggle").removeClass("disabled"),this.$preview.removeClass("expanded"),this.$preview.draggable("destroy").resizable("destroy"),this.$('[data-action="expand-preview"], [data-action="layout-change"], [data-action="full-preview"]').removeClass("display-none"),this.$('[data-action="compress-preview"]').addClass("display-none"),this.$preview.appendTo(".splitter"),this.activateSplitter(),this.updatePreview(),analytics.track(this.editorType+"_editor_preview_notmodal")},previewFull:function(a){this.$el.addClass("preview-maximized"),$(a.currentTarget).addClass("display-none"),this.$('[data-action="compact-preview"]').removeClass("display-none"),this.$('[data-action="layout-change"], [data-action="expand-preview"], [data-action="compress-preview"], [data-action="hide-preview"], [data-action="full-preview"]').addClass("display-none"),this.$preview.css({height:"100%",width:"100%","z-index":"101",top:"0",left:"0","background-color":"#fff"}).appendTo(this.$el).addClass("full"),this.updatePreview(),analytics.track(this.editorType+"_editor_preview_full")},previewCompact:function(a){this.$el.removeClass("preview-maximized"),$(a.currentTarget).addClass("display-none"),this.$('[data-action="layout-change"], [data-action="expand-preview"], [data-action="hide-preview"], [data-action="full-preview"]').removeClass("display-none"),this.$('[data-action="compress-preview"], [data-action="compact-preview"]').addClass("display-none"),this.$preview.appendTo(".splitter").removeClass("full"),this.$ide.hasClass("display-none")?this.$preview.css({height:"100%",left:"0",width:"100%","z-index":"1",top:"0"}):this.$splitter.hasClass("vertical")?(this.$preview.css({height:"100%",left:"50%",width:"50%","z-index":"1"}),this.$ide.width("50%")):(this.$preview.css({height:"50%",left:"0",width:"100%","z-index":"1",top:"50%"}),this.$ide.height("50%")),this.activateSplitter(),this.updatePreview(),analytics.track(this.editorType+"_editor_preview_notfull")},changePreviewFile:function(){this.activePreviewFile=this.files().findWhere({filename:this.$previewSelect.val()}),this.updatePreview()},setContent:function(){this.editor.silent=!0,this.editor.setValue(this.activeFile.content(),1),this.setHighlightMode(),this.editor.silent=!1},setHighlightMode:function(){var a={html:"ace/mode/html",css:"ace/mode/css",sass:"ace/mode/sass",scss:"ace/mode/scss",js:"ace/mode/javascript",java:"ace/mode/java"};this.editor.getSession().setMode(a[this.activeFile.type()])},setActiveFile:function(a,b){if(this.activeFile&&(this.activeFile.set("active",!1),this.activeFile.set("undomanager",this.editor.getSession().getUndoManager()),this.activeFile.set("cursorposition",this.editor.getCursorPosition())),this.activeFile=a,this.activeFile.set({active:!0,opened:!0}),"html"===a.type()){var c=a.get("filename");this.$previewSelect.val(c),!b&&this.activePreviewFile&&this.activePreviewFile.get("filename")==c||(this.activePreviewFile=a,this.updatePreview())}this.setContent(),this.editor.getSession().setUndoManager(a.get("undomanager")||new ace.UndoManager),this.editor.focus();var d=a.get("cursorposition");d?this.editor.moveCursorToPosition(d):this.editor.gotoLine(0,0,!1)},setStartingFile:function(){var a=this.files().findWhere({type:"html"});if("undefined"==typeof a&&(a=this.files().findWhere({type:"java"})),a){var b=this;setTimeout(function(){a.updateBlob(),b.setActiveFile(a,!0)},0)}},switchCodeTab:function(a){analytics.track(this.editorType+"_editor_code_file_changed"),this.setActiveFile(a)},changeFileContent:function(a){this.activeFile.setContent(this.editor.getValue())},setPreviewTitle:function(a){var b=this.$preview.find("header > h2");b.html(App.Templates("previewTitle")({label:b.data("label"),title:a}))},prepareIframe:function(){this.activePreviewFile.injectDependenciesToIframe(this.$iframe);var a=this,b=this.$iframe.contents();this.setPreviewTitle(b.find("title").html()),b.find('[src^="/"]').each(function(){$(this).attr("src",top.location.origin+$(this).attr("src")),["video","audio"].indexOf($(this).parent().prop("tagName").toLowerCase())>=0&&$(this).parent().get(0).load()}),b.find("a").click(function(b){var c=$(this).attr("href"),d=a.files().findWhere({filename:c});if(d)return a.switchCodeTab(d),b.preventDefault(),b.stopPropagation(),!1})}}),App.Views.ExerciseEditor=App.Views.Editor.extend({events:function(){return $.extend({"click .aside-toggle":"asideToggle","click #reset-code-btn":"resetExercise"},this._super())},initialize:function(a){a.signUpModal&&this.listenTo(a.signUpModal,"show",function(){analytics.track("sign_up_modal_shown")});var b=this.$el.data();$.extend(this,b),this.model=this.exercise=this.createModel(b),this._super(a)},render:function(){this.files().invoke("open"),this._super(),setTimeout(function(){var a=this.$("#lesson-nav");a.scrollTop(0);var b=$("#lesson-nav [data-active]").offset().top;a.scrollTop(b-100),a.perfectScrollbar()},0)},prepareView:function(){this._super(),this.setStartingFile(),"undefined"!=typeof this.editor&&this.editor.focus()},onEditorContentChanged:function(a){this.editor.silent||(this.changeFileContent(),clearTimeout(this.updatePreviewTimeout),this.updatePreviewTimeout=setTimeout($.proxy(this.updatePreview,this),500))},updatePreview:function(){this.activePreviewFile.loadToIframe(this.$iframe,!1,$.proxy(this.prepareIframe,this))},analyticsProps:function(){return{}},createModel:function(a){return new App.Models.Exercise($.extend({id:a.exerciseId},a))},asideToggle:function(){var a=this.analyticsProps();this.$("aside").hasClass("open")?analytics.track(this.editorType+"_editor_edu_content-list_closed",a):analytics.track(this.editorType+"_editor_edu_content-list_opened",a),this.$("#lesson-nav").toggleClass("open")},resetExercise:function(a,b){if(confirm($(a.currentTarget).data("confirm-text"))){analytics.track(this.editorType+"_editor_code_reset");var c=this;$.ajax({type:"POST",url:this.resetExerciseUrl()}).done(function(){c.files().invoke("hardReset"),c.fetch()})}a.preventDefault()},saveExercise:function(a){var b={};return this.files().each(function(a){var c=a.get("filename");b[c]={content:a.content(),filename:c,id:a.get("id")}}),$.ajax({type:"POST",url:this.saveExerciseUrl(),data:{exerciseStatus:a,exerciseFiles:JSON.stringify(b)}})}}),App.Views.CourseEditor=App.Views.ExerciseEditor.extend({initialize:function(a){this.exercisePositionInCourse=parseInt(this.$el.data("exercisePositionInCourse"),10),this._super(a)},events:function(){return $.extend({"click .show-tip":"showTip","click #validate-code-btn":"validateCode","click #next-exercise-btn":"nextExercise","click #cheat-sheet-toggle":"cheatSheetToggle"},this._super())},prepareAdditionalViews:function(){this.$errorModal=$("#val-result-error"),this.$successModal=$("#val-result"),this.$nextExerciseButton=$("#next-exercise-btn"),this.$lessonList=$("#lesson-list")},analyticsProps:function(){return{course_id:this.courseId,exercise_id:this.exercise.get("id"),exercise_position_in_course:this.exercisePositionInCourse}},showTip:function(){analytics.track(this.editorType+"_editor_edu_show_tip",this.analyticsProps()),this.$(".tip").removeClass("display-none"),this.$("section.description > article").scrollTop(999999)},validateCode:function(){return this.$("#validate-code-btn").addClass("in-progress"),this.exercise.validate().then($.proxy(this.validationFinished,this)),!1},nextExercise:function(){analytics.track(this.editorType+"_editor_next_exercise",this.analyticsProps())},saveExerciseUrl:function(){return"/"+App.getLang()+"/editor/exercise/save/"+this.pathId+"/"+this.courseId+"/"+this.lessonId+"/"+this.exerciseId},resetExerciseUrl:function(){return"/"+App.getLang()+"/editor/exercise/reset/"+this.pathId+"/"+this.courseId+"/"+this.lessonId+"/"+this.exerciseId},showErrors:function(a){var b=this.files();this.$errorModal.find(".modal-content p").html(App.Templates("validationErrorModalDesc")({filename:b.size()<2?b.at(0).get("filename"):null})),this.$errorModal.find("ul").empty().append($.map(a,function(a){return $("<li>").html(a)})),this.$errorModal.modal("show")},showSuccess:function(){this.$successModal.modal("show"),this.$nextExerciseButton.removeClass("display-none"),this.$lessonList.find(".active").addClass("done")},validationFinished:function(a){this.$("#validate-code-btn").removeClass("in-progress");var b=this.analyticsProps(),c=this;a&&a.length?(analytics.track(this.editorType+"_editor_code_submit_wrong",b),this.saveExercise(0).done(function(){c.showErrors(a)})):(analytics.track(this.editorType+"_editor_code_submit_success",b),this.saveExercise(1).done(function(){currentExerciseIsDone||(currentExerciseIsDone=!0,c.updateNumberOfDoneExercisesInActiveCampaign()),c.showSuccess()}))},updateNumberOfDoneExercisesInActiveCampaign:function(){if("undefined"==typeof Cookies.get("activeCampaignContactId")||"undefined"==typeof Cookies.get("activeCampaignContactEmail")){var a=Cookies.get("doneExercises");return"undefined"==typeof a&&(a=0),a=parseInt(a,10)+1,void Cookies.set("doneExercises",a,{expires:2592e3})}$.ajax({url:"/"+App.getLang()+"/activeCampaign/increaseByOne",method:"POST",data:{id:Cookies.get("activeCampaignContactId"),email:Cookies.get("activeCampaignContactEmail"),fields:["DONE_EXERCISES"]}})},editorType:"course"}),App.Views.PlusExerciseEditor=App.Views.ExerciseEditor.extend({initialize:function(a){this.currentInstructionId=0,this.introductions=[],this.instructions=[],this._super(a)},createModel:function(a){return new App.Models.PlusExercise($.extend({id:a.exerciseId},a))},events:function(){return $.extend({"click #save-code-btn":"saveCode"},this._super())},render:function(){this._super(),this.aside=new App.Views.PlusExerciseAside({el:this.$("#aside"),exercise:this.model})},saveExerciseUrl:function(){return"/"+App.getLang()+"/plus-exercise/save/"+this.exerciseId+"?id="+this.exercise.get("userId")},resetExerciseUrl:function(){return"/"+App.getLang()+"/plus-exercise/reset/"+this.exerciseId+"?id="+this.exercise.get("userId")},saveCode:function(a){this.saveExercise(0)},editorType:"plus-exercise"}),App.Views.PlusExerciseAside=Backbone.View.extend({events:{"click #instruction-page-previous":"previousPage","click #instruction-page-next":"nextPage","click .progress-checkbox":"saveCheckboxes"},initialize:function(a){this.$introduction=this.$("#introduction"),this.$instruction=this.$("#instruction"),this.$percentage=this.$("#percentage"),this.$pageCount=this.$("#page-count"),this.exercise=a.exercise,this.pages=this.exercise.get("pages"),this.progress=this.exercise.get("progress"),this.progress||(this.progress=new App.Models.PlusExerciseProgress({progress:"",done:0}),this.progress.set("exercise",this.exercise)),this.progress.setAllCheckpoints(this.exercise.get("all_checkpoints")),this.currentPage=new Backbone.Model,this.setPage(this.pages.first()),this.listenTo(this.currentPage,"change",this.render),this.render()},render:function(){this.$introduction.html(_.cescape(this.currentPage.get("introduction"),!0)),this.$instruction.html(_.cescape(this.currentPage.get("instruction"),!0)),this.$percentage.html(this.progress.get("percentage")),this.preparePageCheckboxes()},setPage:function(a){this.currentPage.set(a.pick("id","instruction","introduction")),this.updatePageCount()},previousPage:function(){var a=this.pages.get(this.currentPage.get("id")-1);"undefined"!=typeof a&&this.setPage(a)},nextPage:function(){var a=this.pages.get(this.currentPage.get("id")+1);"undefined"!=typeof a&&this.setPage(a)},updatePageCount:function(){this.$pageCount.html(this.currentPage.get("id")+1+"/"+this.pages.length)},preparePageCheckboxes:function(){var a=this,b=1;this.$instruction.find("li").each(function(){var c=$(this),d=c.html(),e=a.currentPage.get("id")+"_"+b,f=$("<label>").addClass("c-input c-checkbox progress-checkbox"),g=$("<span>").addClass("c-indicator"),h=$("<input>").attr("type","checkbox").val(e);a.progress.checkIfChecked(e)&&h.prop("checked",!0),f.html(d).prepend(g).prepend(h),c.html("").prepend(f),b++})},saveCheckboxes:function(a){var b=$(a.currentTarget).find('input[type="checkbox"]');b.is(":checked")?this.progress.checked(b.val()):this.progress.unchecked(b.val()),this.$percentage.html(this.progress.get("percentage"))}});